import{u as ae,e as I,h as L,d as O,H as P}from"./handlers-Nn_8ejmi.js";import{j as s}from"./jsx-runtime-D_zvdyIk.js";import{r as n}from"./iframe-CIsN2Fyl.js";import{H as oe}from"./Header-Avgz259g.js";import{S as ce}from"./ServiceCard-BOMFq_rT.js";import{C as ie}from"./ConfigPanel-Bj3KvomE.js";import{G as le}from"./GitStatus-uD1p5Hzl.js";import{L as ue}from"./LogViewer-BEjNM4ib.js";import{S as z,d as D,a as pe,B as M}from"./StackProgress-DnhpTGoU.js";import{S as de}from"./Spinner-CVL8Mf24.js";import{c as V,a as me,d as ge}from"./fixtures-CTg5x2hB.js";import"./preload-helper-Dp1pzeXC.js";function he(c){const r=n.useRef(c);r.current=c;const o=n.useCallback(()=>{const e=new EventSource("/api/events"),u=l=>p=>{try{const g=JSON.parse(p.data);r.current(l,g)}catch{}};return e.addEventListener("services",u("services")),e.addEventListener("infrastructure",u("infrastructure")),e.addEventListener("health",u("health")),e.addEventListener("log",u("log")),e.addEventListener("stack_progress",u("stack_progress")),e.addEventListener("stack_starting",u("stack_starting")),e.addEventListener("stack_started",u("stack_started")),e.addEventListener("stack_stopped",u("stack_stopped")),e.addEventListener("stack_error",u("stack_error")),e.addEventListener("stack_stopping",u("stack_stopping")),e.onerror=()=>{e.close(),setTimeout(o,3e3)},e},[]);n.useEffect(()=>{const e=o();return()=>e.close()},[o])}const q={running:"#34d399",starting:"#fbbf24",stopping:"#fbbf24",error:"#f87171",stopped:"#6b7280"};function fe(c){const o=document.createElement("canvas");o.width=64,o.height=64;const e=o.getContext("2d");return e?(e.beginPath(),e.arc(64/2,64/2,64/2-2,0,Math.PI*2),e.fillStyle=c,e.fill(),o.toDataURL("image/png")):""}function xe(c,r){const o=n.useRef(null);n.useEffect(()=>{let e=c;r&&(e="error"),e||(e="stopped");const u=q[e]??q.stopped,l=fe(u);if(l){if(!o.current){document.querySelectorAll("link[rel='icon']").forEach(w=>w.remove());const g=document.createElement("link");g.rel="icon",g.type="image/png",document.head.appendChild(g),o.current=g}o.current.href=l}},[c,r])}const H="xcli:notifications";function ke(){const c=n.useRef("Notification"in window?Notification.permission:"unsupported"),[r,o]=n.useState(()=>{const l=localStorage.getItem(H);return l===null?c.current==="granted":l==="true"});n.useEffect(()=>{!r||c.current!=="default"||Notification.requestPermission().then(l=>{c.current=l,l==="denied"&&(o(!1),localStorage.setItem(H,"false"))})},[r]);const e=n.useCallback(()=>{o(l=>{const p=!l;return localStorage.setItem(H,String(p)),p})},[]);return{notify:n.useCallback((l,p)=>{if(!(!r||c.current!=="granted"))try{new Notification(l,{icon:"/icon.png",...p})}catch{}},[r]),enabled:r,toggle:e}}function Q({onNavigateConfig:c}){const{fetchJSON:r,postJSON:o}=ae(),{notify:e,enabled:u,toggle:l}=ke(),[p,g]=n.useState([]),[w,A]=n.useState([]),[_,X]=n.useState(null),[ee,T]=n.useState([]),[h,te]=n.useState(null),x=n.useRef([]),[se,B]=n.useState([]),[d,v]=n.useState(null),[b,j]=n.useState([]),[k,f]=n.useState(null);n.useEffect(()=>{r("/api/status").then(t=>{g(t.services),A(t.infrastructure),X(t.config)}).catch(console.error),r("/api/git").then(t=>{T(t.repos)}).catch(console.error),r("/api/logs").then(t=>{t.length>0&&(x.current=t,B(t))}).catch(console.error),r("/api/stack/status").then(t=>{v(t.status),t.error&&f(t.error),t.progress&&t.progress.length>0&&j(t.progress)}).catch(console.error);const a=setInterval(()=>{r("/api/git").then(t=>{T(t.repos)}).catch(console.error)},6e4);return()=>{clearInterval(a)}},[r]);const ne=n.useCallback((a,t)=>{switch(a){case"services":{const i=t;g(S=>{const y=new Map(S.map(m=>[m.name,m.health]));return i.map(m=>({...m,health:m.health&&m.health!=="unknown"?m.health:y.get(m.name)??m.health}))});break}case"infrastructure":A(t);break;case"health":{const i=t;g(S=>S.map(y=>{const m=i[y.name];return m?{...y,health:m.Status}:y}));break}case"log":{const i=t;x.current=[...x.current.slice(-9999),i],B(x.current);break}case"stack_progress":{const i=t;j(S=>[...S,i]);break}case"stack_starting":v("starting"),j([]),f(null);break;case"stack_started":v("running"),e("xcli: Stack Booted ðŸ†",{body:"All services are up and running."});break;case"stack_error":{const i=t,S=(i==null?void 0:i.error)??"Unknown error";f(S);break}case"stack_stopping":v("stopping"),j([]),f(null);break;case"stack_stopped":v("stopped"),j([]),f(null),e("xcli: Stack Stopped ðŸ†",{body:"All services have been stopped."});break;case"stack_status":{const i=t;v(i.status),i.error&&f(i.error);break}}},[e]);he(ne),xe(d,!!k),n.useEffect(()=>{if(!h)return;const a=p.find(t=>t.name===h);!a||a.status==="running"||!a.logFile||r(`/api/services/${encodeURIComponent(h)}/logs`).then(t=>{t.length>0&&(x.current=[...x.current.filter(i=>i.Service!==h),...t],B(x.current))}).catch(console.error)},[h,p,r]);const re=n.useCallback(()=>{o("/api/stack/cancel").catch(console.error)},[o]),E=n.useCallback(()=>{if(!d||d==="starting"||d==="stopping")return;o(d==="running"?"/api/stack/down":"/api/stack/up").catch(console.error)},[d,o]);return s.jsxs("div",{className:"flex h-dvh flex-col",children:[s.jsx(oe,{services:p,infrastructure:w,mode:(_==null?void 0:_.mode)??"",onNavigateConfig:c,stackStatus:d,onStackAction:E,currentPhase:b.length>0?b[b.length-1].message:void 0,notificationsEnabled:u,onToggleNotifications:l}),s.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[s.jsxs("div",{className:"flex w-72 shrink-0 flex-col gap-3 overflow-y-auto border-r border-border bg-surface p-3",children:[s.jsx("div",{className:"text-xs/4 font-semibold tracking-wider text-text-muted uppercase",children:"Services"}),p.map(a=>s.jsx(ce,{service:a,selected:h===a.name,onSelect:()=>te(h===a.name?null:a.name)},a.name)),w.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"mt-2 text-xs/4 font-semibold tracking-wider text-text-muted uppercase",children:"Infrastructure"}),w.map(a=>s.jsxs("div",{className:"flex items-center justify-between rounded-sm border border-border bg-surface-light p-3",children:[s.jsx("span",{className:"text-sm/5 font-medium text-text-primary",children:a.name}),s.jsx("span",{className:`text-xs/4 font-medium ${a.status==="running"?"text-success":"text-text-muted"}`,children:a.status})]},a.name))]})]}),s.jsx("div",{className:"flex-1 overflow-hidden p-3",children:d===null?s.jsx(de,{centered:!0}):d==="starting"||d==="stopping"?s.jsx(z,{phases:D(b,k,d==="stopping"?pe:M),error:k,title:d==="stopping"?"Stopping Stack":"Booting Stack",onCancel:d==="starting"?re:void 0}):k?b.length>0?s.jsx(z,{phases:D(b,k,M),error:k,title:"Boot Failed",onRetry:()=>{f(null),j([]),E()}}):s.jsxs("div",{className:"flex h-full flex-col items-center justify-center gap-4",children:[s.jsx("svg",{className:"size-12 text-error",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})}),s.jsx("p",{className:"text-sm font-medium text-error",children:"Stack boot failed"}),s.jsx("p",{className:"max-w-md text-center font-mono text-xs/5 text-error/70",children:k}),s.jsx("button",{onClick:()=>{f(null),E()},className:"mt-2 rounded-md bg-success/20 px-4 py-2 text-sm font-medium text-success transition-colors hover:bg-success/30",children:"Retry Boot"})]}):p.some(a=>a.status==="running")||h?s.jsx(ue,{logs:se,selectedService:h}):s.jsxs("div",{className:"flex h-full flex-col items-center justify-center gap-4 text-text-muted",children:[s.jsx("svg",{className:"size-16 text-border",fill:"none",viewBox:"0 0 24 24",strokeWidth:1,stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3m3 3a3 3 0 1 0 0 6h13.5a3 3 0 1 0 0-6m-16.5-3a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3m-19.5 0a4.5 4.5 0 0 1 .9-2.7L5.737 5.1a3.375 3.375 0 0 1 2.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 0 1 .9 2.7m0 0a3 3 0 0 1-3 3m0 3h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Z"})}),s.jsx("p",{className:"text-sm",children:"Stack is not running"}),s.jsx("button",{onClick:E,className:"rounded-md bg-success/20 px-4 py-2 text-sm font-medium text-success transition-colors hover:bg-success/30",children:"Boot Stack"})]})}),s.jsxs("div",{className:"flex w-72 shrink-0 flex-col gap-3 overflow-y-auto border-l border-border bg-surface p-3",children:[s.jsx(ie,{config:_,services:p,onNavigateConfig:c}),s.jsx(le,{repos:ee})]})]})]})}Q.__docgenInfo={description:"",methods:[],displayName:"Dashboard",props:{onNavigateConfig:{required:!1,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""}}};const{fn:Se}=__STORYBOOK_MODULE_TEST__,Pe={title:"Components/Dashboard",component:Q,parameters:{msw:{handlers:I}},args:{onNavigateConfig:Se()}},N={},R={parameters:{msw:{handlers:[L.get("/api/status",async()=>(await O(100),P.json({...V,services:me.map(c=>({...c,status:"stopped",pid:0,uptime:""}))}))),L.get("/api/stack/status",async()=>(await O(100),P.json({...ge,status:"stopped",runningServices:0}))),...I.slice(2)]}}},C={parameters:{msw:{handlers:[L.get("/api/status",async()=>(await O(100),P.json({...V,services:[]}))),L.get("/api/stack/status",async()=>(await O(100),P.json({status:"starting",runningServices:0,totalServices:5,progress:[{phase:"prerequisites",message:"Done"},{phase:"build_xatu_cbt",message:"Building..."}]}))),...I.slice(2)]}}};var F,U,G;N.parameters={...N.parameters,docs:{...(F=N.parameters)==null?void 0:F.docs,source:{originalSource:"{}",...(G=(U=N.parameters)==null?void 0:U.docs)==null?void 0:G.source}}};var J,Z,K;R.parameters={...R.parameters,docs:{...(J=R.parameters)==null?void 0:J.docs,source:{originalSource:`{
  parameters: {
    msw: {
      handlers: [http.get('/api/status', async () => {
        await delay(100);
        return HttpResponse.json({
          ...mockStatusResponse,
          services: mockServices.map(s => ({
            ...s,
            status: 'stopped',
            pid: 0,
            uptime: ''
          }))
        });
      }), http.get('/api/stack/status', async () => {
        await delay(100);
        return HttpResponse.json({
          ...mockStackStatus,
          status: 'stopped',
          runningServices: 0
        });
      }), ...allHandlers.slice(2)]
    }
  }
}`,...(K=(Z=R.parameters)==null?void 0:Z.docs)==null?void 0:K.source}}};var W,Y,$;C.parameters={...C.parameters,docs:{...(W=C.parameters)==null?void 0:W.docs,source:{originalSource:`{
  parameters: {
    msw: {
      handlers: [http.get('/api/status', async () => {
        await delay(100);
        return HttpResponse.json({
          ...mockStatusResponse,
          services: []
        });
      }), http.get('/api/stack/status', async () => {
        await delay(100);
        return HttpResponse.json({
          status: 'starting',
          runningServices: 0,
          totalServices: 5,
          progress: [{
            phase: 'prerequisites',
            message: 'Done'
          }, {
            phase: 'build_xatu_cbt',
            message: 'Building...'
          }]
        });
      }), ...allHandlers.slice(2)]
    }
  }
}`,...($=(Y=C.parameters)==null?void 0:Y.docs)==null?void 0:$.source}}};const Be=["Running","Stopped","Starting"];export{N as Running,C as Starting,R as Stopped,Be as __namedExportsOrder,Pe as default};
