import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{r as i}from"./iframe-CIsN2Fyl.js";import{u as ee}from"./handlers-Nn_8ejmi.js";import{S as te}from"./Spinner-CVL8Mf24.js";function se({onToast:l}){const{fetchJSON:d,putJSON:c,postAction:b}=ee(),[s,x]=i.useState(null),[j,N]=i.useState(!1),[S,g]=i.useState(!1),[E,W]=i.useState(!1),[k,P]=i.useState(!1),[w,H]=i.useState(""),[M,q]=i.useState(""),[f,L]=i.useState(null),[p,J]=i.useState(!1),[O,X]=i.useState(!1);i.useEffect(()=>{d("/api/config/overrides").then(x).catch(t=>l(t.message,"error")),d("/api/config").then(t=>P(t.mode==="hybrid")).catch(()=>{})},[d]);const K=async()=>{if(s){N(!0);try{const t=await c("/api/config/overrides",s);if(t.regenerateError)l(`Saved but regen failed: ${t.regenerateError}`,"error");else{l("Overrides saved and configs regenerated","success");try{(await d("/api/status")).services.some(n=>(n.name.startsWith("cbt-")||n.name.startsWith("cbt-api-")||k&&n.name==="lab-backend")&&n.status==="running")&&g(!0)}catch{g(!0)}}}catch(t){l(t instanceof Error?t.message:"Save failed","error")}finally{N(!1)}}},G=async()=>{W(!0);try{const t=await d("/api/services"),r=t.filter(o=>o.name.startsWith("cbt-")&&!o.name.startsWith("cbt-api-")&&o.status==="running");for(const o of r)await b(o.name,"restart");let a=!1;if(k){const o=t.find(h=>h.name==="lab-backend"&&h.status==="running");o&&(await b(o.name,"restart"),a=!0)}const n=[];r.length>0&&n.push(`${r.length} xatu-cbt`),a&&n.push("lab-backend"),n.length>0?l(`Restarted ${n.join(" + ")}`,"success"):l("No running services found to restart","error")}catch(t){l(t instanceof Error?t.message:"Restart failed","error")}finally{W(!1),g(!1)}},D=(t,r)=>{if(!s)return;const a=[...s[t]],n={...a[r],enabled:!a[r].enabled};a[r]=n,x({...s,[t]:a}),!n.enabled&&f===n.name&&L(null)},y=(t,r)=>{if(!s)return;const a=s[t].map(n=>({...n,enabled:r}));x({...s,[t]:a})},$=i.useMemo(()=>{var a;if(!s)return new Set;const t=new Set,r=new Set;for(const n of s.externalModels)n.enabled&&r.add(n.name);for(const n of s.transformationModels)n.enabled&&r.add(n.name);for(const n of s.transformationModels){if(!n.enabled)continue;const o=(a=s.dependencies)==null?void 0:a[n.name];if(o)for(const h of o)r.has(h)||t.add(h)}return t},[s]),v=$.size,T=i.useMemo(()=>{var a;if(!s||!f)return null;const t=(a=s.dependencies)==null?void 0:a[f];if(!t||t.length===0)return null;const r=new Set;for(const n of s.externalModels)n.enabled&&r.add(n.name);for(const n of s.transformationModels)n.enabled&&r.add(n.name);return t.map(n=>({name:n,enabled:r.has(n)}))},[s,f]),Q=i.useCallback(()=>{if(!s)return;const t=s.dependencies??{},r=new Map(s.externalModels.map((u,m)=>[u.name,m])),a=new Map(s.transformationModels.map((u,m)=>[u.name,m])),n=s.externalModels.map(u=>({...u})),o=s.transformationModels.map(u=>({...u}));let h=!0,C=0;for(;h;){h=!1;const u=new Set;for(const m of n)m.enabled&&u.add(m.name);for(const m of o)m.enabled&&u.add(m.name);for(const m of o){if(!m.enabled)continue;const F=t[m.name];if(F)for(const z of F){if(u.has(z))continue;const A=r.get(z);A!==void 0&&!n[A].enabled&&(n[A].enabled=!0,h=!0,C++);const I=a.get(z);I!==void 0&&!o[I].enabled&&(o[I].enabled=!0,h=!0,C++)}}}x({...s,externalModels:n,transformationModels:o}),C>0?l(`Enabled ${C} missing dependencies`,"success"):l("No missing dependencies","success")},[s,l]),U=i.useMemo(()=>{if(!s||!w&&!p)return null;const t=w.toLowerCase();return s.externalModels.map((r,a)=>({...r,originalIndex:a})).filter(r=>!(p&&!r.enabled||t&&!r.name.toLowerCase().includes(t)))},[s,w,p]),Y=i.useMemo(()=>{if(!s||!M&&!p)return null;const t=M.toLowerCase();return s.transformationModels.map((r,a)=>({...r,originalIndex:a})).filter(r=>!(p&&!r.enabled||t&&!r.name.toLowerCase().includes(t)))},[s,M,p]);if(!s)return e.jsx(te,{text:"Loading overrides",centered:!0});const B=s.externalModels.filter(t=>t.enabled).length,R=s.transformationModels.filter(t=>t.enabled).length;return e.jsxs("div",{className:"mx-auto max-w-6xl",children:[e.jsxs("div",{className:"flex flex-col gap-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>J(t=>!t),className:`flex items-center gap-1.5 rounded-xs px-3 py-1.5 text-xs/4 font-medium transition-colors ${p?"bg-accent/15 text-accent-light ring-1 ring-accent/25":"text-text-muted hover:bg-white/5 hover:text-text-secondary"}`,children:[e.jsx("svg",{className:"size-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z"})}),p?"Enabled only":"Show all"]}),e.jsxs("button",{onClick:()=>X(t=>!t),className:`flex items-center gap-1.5 rounded-xs px-3 py-1.5 text-xs/4 font-medium transition-colors ${O?"bg-accent/15 text-accent-light ring-1 ring-accent/25":"text-text-muted hover:bg-white/5 hover:text-text-secondary"}`,children:[e.jsx("svg",{className:"size-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4.745 3A23.933 23.933 0 0 0 3 12c0 3.183.62 6.22 1.745 9M19.5 3c.967 2.78 1.5 5.817 1.5 9s-.533 6.22-1.5 9M8.25 8.885l1.444-.89a.75.75 0 0 1 1.105.402l2.402 7.206a.75.75 0 0 0 1.104.401l1.445-.889"})}),"Environment"]})]}),v>0&&e.jsxs("button",{onClick:Q,className:"flex items-center gap-1.5 rounded-xs bg-warning/10 px-3 py-1.5 text-xs/4 font-medium text-warning ring-1 ring-warning/20 transition-colors hover:bg-warning/20",children:[e.jsx("svg",{className:"size-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"})}),v," missing dep",v>1?"s":""," â€” fix"]})]}),O&&e.jsxs("div",{className:"rounded-sm border border-border bg-surface-light p-4",children:[e.jsx("div",{className:"mb-3 text-xs/4 font-semibold tracking-wider text-text-muted uppercase",children:"Environment Variables"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(_,{label:"EXTERNAL_MODEL_MIN_TIMESTAMP",value:s.envMinTimestamp,enabled:s.envTimestampEnabled,onValueChange:t=>x({...s,envMinTimestamp:t}),onEnabledChange:t=>x({...s,envTimestampEnabled:t})}),e.jsx(_,{label:"EXTERNAL_MODEL_MIN_BLOCK",value:s.envMinBlock,enabled:s.envBlockEnabled,onValueChange:t=>x({...s,envMinBlock:t}),onEnabledChange:t=>x({...s,envBlockEnabled:t})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-0 overflow-hidden rounded-sm border border-border",children:[e.jsx(V,{title:"External Models",enabledCount:B,totalCount:s.externalModels.length,filter:w,onFilterChange:H,onEnableAll:()=>y("externalModels",!0),onDisableAll:()=>y("externalModels",!1),children:e.jsx("div",{className:"flex flex-col",children:(U??s.externalModels.map((t,r)=>({...t,originalIndex:r}))).map(t=>e.jsx(Z,{model:t,needed:$.has(t.name),isSelected:f===t.name,onToggle:()=>D("externalModels",t.originalIndex),onSelect:()=>L(f===t.name?null:t.name)},t.name))})}),e.jsx(V,{title:"Transformation Models",enabledCount:R,totalCount:s.transformationModels.length,filter:M,onFilterChange:q,onEnableAll:()=>y("transformationModels",!0),onDisableAll:()=>y("transformationModels",!1),borderLeft:!0,children:e.jsx("div",{className:"flex flex-col",children:(Y??s.transformationModels.map((t,r)=>({...t,originalIndex:r}))).map(t=>{var r,a;return e.jsx(Z,{model:t,needed:$.has(t.name),isSelected:f===t.name,hasDeps:!!((a=(r=s.dependencies)==null?void 0:r[t.name])!=null&&a.length),onToggle:()=>D("transformationModels",t.originalIndex),onSelect:()=>L(f===t.name?null:t.name)},t.name)})})})]}),f&&T&&e.jsxs("div",{className:"rounded-sm border border-border bg-surface-light p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center gap-2",children:[e.jsx("svg",{className:"size-4 text-text-muted",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"})}),e.jsx("span",{className:"text-xs/4 font-medium text-text-tertiary",children:"Dependencies of"}),e.jsx("code",{className:"rounded-xs bg-accent/10 px-1.5 py-0.5 text-xs/4 text-accent-light",children:f})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:T.map(t=>e.jsxs("span",{className:`flex items-center gap-1 rounded-xs px-2 py-1 font-mono text-xs/4 ${t.enabled?"bg-success/10 text-success":"bg-error/10 text-error"}`,children:[t.enabled?e.jsx("svg",{className:"size-3",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:3,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 12.75 6 6 9-13.5"})}):e.jsx("svg",{className:"size-3",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:3,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"})}),t.name]},t.name))})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-sm border border-border bg-surface-light px-4 py-3",children:[e.jsxs("span",{className:"text-xs/4 text-text-disabled",children:[B+R," model",B+R!==1?"s":""," enabled",v>0&&e.jsxs("span",{className:"ml-1 text-warning",children:["(",v," missing dep",v>1?"s":"",")"]})]}),e.jsx("button",{onClick:K,disabled:j,className:"rounded-xs bg-accent px-4 py-1.5 text-sm/5 font-medium text-text-primary transition-colors hover:bg-accent-light disabled:opacity-50",children:j?"Saving...":"Save Overrides"})]})]}),S&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-overlay/60",children:e.jsx("div",{className:"w-full max-w-sm rounded-sm border border-border bg-surface-light p-6 shadow-xl",children:E?e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("div",{className:"size-6 animate-spin rounded-full border-2 border-accent-light border-t-transparent"}),e.jsxs("span",{className:"text-sm/5 text-accent-light",children:["Restarting ",k?"xatu-cbt + lab-backend":"xatu-cbt"," services..."]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsx("svg",{className:"size-5 text-accent-light",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182M2.985 19.644l3.181-3.183"})}),e.jsx("h3",{className:"text-sm/5 font-semibold text-text-primary",children:"Restart Services"})]}),e.jsxs("p",{className:"mt-2 text-sm/5 text-text-tertiary",children:["Restart ",k?"xatu-cbt and lab-backend":"xatu-cbt services"," to apply the new overrides?"]}),e.jsxs("div",{className:"mt-5 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>g(!1),className:"rounded-xs px-3 py-1.5 text-xs/4 font-medium text-text-muted transition-colors hover:text-text-secondary",children:"Skip"}),e.jsx("button",{onClick:G,className:"rounded-xs bg-accent px-3 py-1.5 text-xs/4 font-medium text-text-primary transition-colors hover:bg-accent-light",children:"Restart"})]})]})})})]})}function V({title:l,enabledCount:d,totalCount:c,filter:b,onFilterChange:s,onEnableAll:x,onDisableAll:j,borderLeft:N,children:S}){const g=c>0?d/c*100:0;return e.jsxs("div",{className:`flex flex-col bg-surface ${N?"border-l border-border":""}`,children:[e.jsxs("div",{className:"border-b border-border px-4 py-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:"text-sm/5 font-semibold text-text-secondary",children:l}),e.jsxs("span",{className:"font-mono text-xs/4 text-text-disabled",children:[d,"/",c]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:x,className:"rounded-xs px-2 py-0.5 text-xs/4 font-medium text-text-muted transition-colors hover:bg-white/5 hover:text-success",children:"All"}),e.jsx("span",{className:"text-border",children:"/"}),e.jsx("button",{onClick:j,className:"rounded-xs px-2 py-0.5 text-xs/4 font-medium text-text-muted transition-colors hover:bg-white/5 hover:text-error",children:"None"})]})]}),e.jsx("div",{className:"mt-2 h-0.5 w-full rounded-full bg-surface-lighter",children:e.jsx("div",{className:"h-full rounded-full bg-accent/60 transition-all duration-300",style:{width:`${g}%`}})})]}),e.jsx("div",{className:"border-b border-border/50 px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 rounded-xs bg-surface-light px-2.5 py-1.5",children:[e.jsx("svg",{className:"size-3.5 shrink-0 text-text-disabled",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})}),e.jsx("input",{type:"text",value:b,onChange:E=>s(E.target.value),placeholder:"Filter...",className:"w-full bg-transparent text-sm/5 text-text-primary placeholder:text-text-disabled focus:outline-hidden"}),b&&e.jsx("button",{onClick:()=>s(""),className:"shrink-0 text-text-disabled hover:text-text-tertiary",children:e.jsx("svg",{className:"size-3",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"})})})]})}),e.jsx("div",{className:"max-h-[28rem] overflow-y-auto",children:S})]})}function Z({model:l,needed:d,isSelected:c,hasDeps:b,onToggle:s,onSelect:x}){return e.jsxs("div",{className:`group flex items-center gap-3 border-b border-border/30 px-4 py-2 transition-colors last:border-b-0 ${c?"bg-accent/5":"hover:bg-white/[0.02]"}`,children:[e.jsxs("button",{onClick:s,className:"relative shrink-0","aria-label":`Toggle ${l.name}`,children:[e.jsx("div",{className:`h-4 w-7 rounded-full transition-colors ${l.enabled?"bg-success/80":d?"bg-warning/30":"bg-surface-lighter"}`}),e.jsx("div",{className:`absolute top-0.5 left-0.5 size-3 rounded-full transition-all ${l.enabled?"translate-x-3 bg-text-primary":d?"bg-warning":"bg-text-muted"}`})]}),e.jsx("button",{onClick:s,className:"min-w-0 flex-1 text-left",children:e.jsx("span",{className:`truncate font-mono text-xs/4 ${l.enabled?"text-text-secondary":d?"text-warning":"text-text-muted"}`,children:l.name})}),d&&!l.enabled&&e.jsx("span",{className:"shrink-0 text-xs/4 font-medium text-warning",title:"Required by an enabled model",children:"!"}),b&&e.jsx("button",{onClick:x,className:`shrink-0 rounded-xs p-0.5 transition-colors ${c?"text-accent-light":"text-border hover:text-text-tertiary"}`,title:"View dependencies",children:e.jsx("svg",{className:"size-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"})})})]})}function _({label:l,value:d,enabled:c,onValueChange:b,onEnabledChange:s}){return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>s(!c),className:"relative shrink-0","aria-label":`Toggle ${l}`,children:[e.jsx("div",{className:`h-4 w-7 rounded-full transition-colors ${c?"bg-accent/80":"bg-surface-lighter"}`}),e.jsx("div",{className:`absolute top-0.5 left-0.5 size-3 rounded-full transition-all ${c?"translate-x-3 bg-text-primary":"bg-text-muted"}`})]}),e.jsx("code",{className:`w-72 shrink-0 text-xs/4 ${c?"text-text-secondary":"text-text-disabled"}`,children:l}),e.jsx("input",{type:"text",value:d,onChange:x=>b(x.target.value),disabled:!c,className:"flex-1 rounded-xs border border-border bg-surface px-3 py-1.5 font-mono text-sm/5 text-text-primary placeholder:text-text-disabled disabled:opacity-30",placeholder:"0"})]})}se.__docgenInfo={description:"",methods:[],displayName:"CBTOverridesEditor",props:{onToast:{required:!0,tsType:{name:"signature",type:"function",raw:"(message: string, type: 'success' | 'error') => void",signature:{arguments:[{type:{name:"string"},name:"message"},{type:{name:"union",raw:"'success' | 'error'",elements:[{name:"literal",value:"'success'"},{name:"literal",value:"'error'"}]},name:"type"}],return:{name:"void"}}},description:""}}};export{se as C};
